<!DOCTYPE html>
<head>
    <script src="js/lib/jquery.js"></script>
    <script src="js/hightimes.js"></script>
    <script src="js/config.js"></script>
    <script src="js/instagram.js"></script>
</head>

<body>
<h1>Welcome</h1>
<p id="welcome">Wait while we load you profile....</p>
</body>
<script>
    $(document).ready(hightimes.login);

    var Page = function(data){
        this._data = data;
    };
    Page.prototype.hasError = function(){
        return this._data.meta.code != 200;
    };

    Page.prototype.getError = function(){
        return this._data.meta.error_type + ": " +this._data.meta.error_message;
    };

    Page.prototype.hasNext = function(){
        return !!this._data.pagination.next_url;
    };

    Page.prototype.nextUrl = function(){
        return this._data.pagination.next_url;
    };


    Page.prototype.dataList = function(){
        return this._data.data;
    };



    var PagedResource = function(url){
        this.url = url;
    };

    PagedResource.prototype.fetchPage = function(url, onFetch){
        $.ajax({
            url: url,
            dataType: 'jsonp',
            type: 'GET',
            data: {client_id: "eafbdb4095514998ad2d06fe47f8db03"},
            success: onFetch,
            error: function (data) {
                console.log(data);
            }
        })
    };

    PagedResource.prototype.forEach = function(callback){
        var fetchPage = this.fetchPage;

        var load = function(url, fetchNextPage, callback){
            fetchNextPage(url, function (response) {
                var page = new Page(response);
                if(page.hasError()){
                    console.error(page.getError()+" -url: " +url);
                } else{
                    callback(page);
                    if(page.hasNext()){
                        load(page.nextUrl(),fetchNextPage, callback)
                    }
                }
            })
        };

        load(this.url, fetchPage, callback);
    };


    var forAllPostsOfFollowersDo = function(userID, forEachFollowersDo, forEachFollowerPostDo){
        var url = "https://api.instagram.com/v1/users/<user-id>/followed-by".replace("<user-id>", userID);
        var pageCount =1;

        new PagedResource(url).forEach(function(page){
            console.log("Followers on page-" +(pageCount++)+" : ")
            var followers = page.dataList();
            for(var i =0; i < followers.length; i++){
                var follower = followers[i];
                forEachFollowersDo(follower);

                var userPostsUrl = "https://api.instagram.com/v1/users/<user-id>/media/recent".replace("<user-id>", follower.id);
                new PagedResource(userPostsUrl).forEach(function(page){
                    if(page.dataList()){
                        var posts = page.dataList();
                        for(var i =0; i<posts.length; i++){
                            forEachFollowerPostDo(follower, posts[i]);
                        }
                    }else {
                        console.error("no posts found for " + follower.id)
                    }
                });
            }
        });

    }
    var forEachFollowersDo = function(user){
        console.log("Analyzing behaviour of "+user.full_name)
    };

    var forEachFollowerPostDo = function(user, post){
        console.log(user.full_name+ " posted "+ post.type + " at "+post.created_time);
    };

    forAllPostsOfFollowersDo("1924007889", forEachFollowersDo, forEachFollowerPostDo);





</script>
</html>